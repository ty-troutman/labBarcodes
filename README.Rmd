---
title: "README"
output: github_document
---

```{r, include=FALSE}
library(tidyverse)
library(bioseq)
library(DNABarcodes)
library(pheatmap)
library(viridis)
```

Generate barcode sheet for Nextera PCR primers from **[Supplementary Table 1](https://static-content.springer.com/esm/art%3A10.1038%2Fnature14590/MediaObjects/41586_2015_BFnature14590_MOESM36_ESM.xlsx)**:  
[Buenrostro JD, Wu B, Litzenburger UM, Ruff D, Gonzales ML, Snyder MP, Chang HY, Greenleaf WJ. Single-cell chromatin accessibility reveals principles of regulatory variation. Nature. 2015 Jul 23;523(7561):486-90. doi: 10.1038/nature14590. Epub 2015 Jun 17. PMID: 26083756; PMCID: PMC4685948.](https://pubmed.ncbi.nlm.nih.gov/26083756/)  

```{r, message=FALSE}
Nextera_I7_Primers <- readxl::read_excel("data/41586_2015_BFnature14590_MOESM36_ESM.xlsx") %>% 
  rename(Index_ID = 1, FullPrimer = 2) %>%
  filter(str_detect(Index_ID, "v2_Ad2\\.")) %>%
  separate(Index_ID, into = c("id1", "id2", "I7_Primer_Sequence"), sep = "_", remove = FALSE) %>%
  unite(col = Index_ID, id1:id2, sep = "_") %>%
  mutate(I7_Index = I7_Primer_Sequence) %>%
  mutate(I7_Index = dna(I7_Index)) %>%
  mutate(I7_Index = seq_complement(I7_Index)) %>%
  mutate(I7_Index = seq_reverse((I7_Index))) %>%
  select(Index_ID, I7_Index, I7_Primer_Sequence, FullPrimer) %>%
  write_csv(file = "barcodes/Nextera_I7_Primers.csv")

Nextera_I5_Primers <- readxl::read_excel("data/41586_2015_BFnature14590_MOESM36_ESM.xlsx") %>% 
  rename(Index_ID = 1, FullPrimer = 2) %>%
  filter(str_detect(Index_ID, "v2_Ad1\\.")) %>%
  separate(Index_ID, into = c("id1", "id2", "I5_Primer_Sequence"), sep = "_", remove = FALSE) %>%
  unite(col = Index_ID, id1:id2, sep = "_") %>%
  mutate(I5_Reverse_Complement = I5_Primer_Sequence) %>%
  mutate(I5_Reverse_Complement = dna(I5_Reverse_Complement)) %>%
  mutate(I5_Reverse_Complement = seq_complement(I5_Reverse_Complement)) %>%
  mutate(I5_Reverse_Complement = seq_reverse((I5_Reverse_Complement))) %>%
  select(Index_ID, I5_Primer_Sequence, I5_Reverse_Complement, FullPrimer) %>%
  write_csv(file = "barcodes/Nextera_I5_Primers.csv")
```

### Compare Hamming Distance of I7 Nextera indexes to I7 NextFlex 289:384 indexes

```{r, include = F}
NextFlex <- readxl::read_excel("data/NEXTflex_UDI_Index_Sequences_v21.06_v1-New.xlsx") %>% 
  rename(Index_ID = 1, I7_Index = 2, I5_Primer_Sequence = 3, I5_Reverse_Complement = 4)

I7_Merged <-
  bind_rows(
  Nextera_I7_Primers %>% select(Index_ID, I7_Index),
  NextFlex %>% slice(289:384) %>% select(Index_ID, I7_Index)
)

tmp <- barcode.set.distances(pull(I7_Merged, I7_Index), metric = c("hamming"))
rownames(tmp) <- I7_Merged$Index_ID
colnames(tmp) <- I7_Merged$Index_ID
x1 <- tmp@x
nameX <- tmp@Dimnames
nameY <- tmp@Dimnames
tmp <- as.matrix(tmp, row.names = tmp@Dimnames)
tmp <- as.data.frame(tmp)
tmp <- tmp %>% rownames_to_column(., var = "rowname") %>% as_tibble()
tmp2 <- tmp %>% pivot_longer(cols = -1, names_to = "barcode", values_to = "hamming")

tmp <- barcode.set.distances(pull(I7_Merged, I7_Index), metric = c("seqlev"))
rownames(tmp) <- I7_Merged$Index_ID
colnames(tmp) <- I7_Merged$Index_ID
x1 <- tmp@x
nameX <- tmp@Dimnames
nameY <- tmp@Dimnames
tmp <- as.matrix(tmp, row.names = tmp@Dimnames)
tmp <- as.data.frame(tmp)
tmp <- tmp %>% rownames_to_column(., var = "rowname") %>% as_tibble()
tmp <- tmp %>% pivot_longer(cols = -1, names_to = "barcode", values_to = "seqlev")

i7 <- full_join(tmp, tmp2)

i7_tmp <-
  i7 %>% sample_frac(size = 1, replace = FALSE) %>% 
  filter(str_detect(rowname, "UDI")) %>%
  filter(str_detect(barcode, "v2")) %>%
  select(-seqlev) %>%
  filter(hamming > 2) %>%
  pivot_wider(names_from = barcode, values_from = hamming) %>%
  arrange(rowname) %>%
  column_to_rownames(var = "rowname")

pheatmap(
  i7_tmp,
  cluster_rows = T,
  cluster_cols = T,
  fontsize = 10,
  fontsize_row = 6,
  fontsize_col = 6,
  border_color = NA,
  color = viridis(
    n = 6,
    direction = -1,
    option = "rocket",
    end = 0.8
  ),
  clustering_method = "ward.D",
  na_col = "white",
  main = "I7 barcode Hamming distances, Hamming > 2",
  filename = "plots/i7_hamming_greater2.pdf",
  width = 10,
  height = 7.5
)

pheatmap(
  i7_tmp,
  cluster_rows = F,
  cluster_cols = F,
  fontsize = 10,
  fontsize_row = 6,
  fontsize_col = 6,
  border_color = NA,
  color = viridis(
    n = 6,
    direction = -1,
    option = "rocket",
    end = 0.8
  ),
  na_col = "white",
  main = "I7 barcode Hamming distances, Hamming > 2",
  filename = "plots/i7_hamming_greater2_unclustered.pdf",
  width = 10,
  height = 7.5
)

pheatmap(
  i7_tmp,
  cluster_rows = T,
  cluster_cols = T,
  fontsize = 10,
  fontsize_row = 6,
  fontsize_col = 6,
  border_color = NA,
  color = viridis(
    n = 6,
    direction = -1,
    option = "rocket",
    end = 0.8
  ),
  clustering_method = "ward.D",
  na_col = "white",
  main = "I7 barcode Hamming distances, Hamming > 2",
  filename = "plots/i7_hamming_greater2.png",
  width = 10,
  height = 7.5
)

pheatmap(
  i7_tmp,
  cluster_rows = F,
  cluster_cols = F,
  fontsize = 10,
  fontsize_row = 6,
  fontsize_col = 6,
  border_color = NA,
  color = viridis(
    n = 6,
    direction = -1,
    option = "rocket",
    end = 0.8
  ),
  na_col = "white",
  main = "I7 barcode Hamming distances, Hamming > 2",
  filename = "plots/i7_hamming_greater2_unclustered.png",
  width = 10,
  height = 7.5
)
```

![I7 hamming distance > 2](plots/i7_hamming_greater2.png)

![I7 hamming distance > 2](plots/i7_hamming_greater2_unclustered.png)

### Compare Hamming Distance of I5 Nextera indexes to I5 NextFlex 289:384 indexes

```{r, include=FALSE}
I5_Merged <-
  bind_rows(
  Nextera_I5_Primers %>% select(Index_ID, I5_Primer_Sequence),
  NextFlex %>% slice(289:384) %>% select(Index_ID, I5_Primer_Sequence)
)

tmp <- barcode.set.distances(pull(I5_Merged, I5_Primer_Sequence), metric = c("hamming"))
rownames(tmp) <- I5_Merged$Index_ID
colnames(tmp) <- I5_Merged$Index_ID
x1 <- tmp@x
nameX <- tmp@Dimnames
nameY <- tmp@Dimnames
tmp <- as.matrix(tmp, row.names = tmp@Dimnames)
tmp <- as.data.frame(tmp)
tmp <- tmp %>% rownames_to_column(., var = "rowname") %>% as_tibble()
tmp2 <- tmp %>% pivot_longer(cols = -1, names_to = "barcode", values_to = "hamming")

tmp <- barcode.set.distances(pull(I5_Merged, I5_Primer_Sequence), metric = c("seqlev"))
rownames(tmp) <- I5_Merged$Index_ID
colnames(tmp) <- I5_Merged$Index_ID
x1 <- tmp@x
nameX <- tmp@Dimnames
nameY <- tmp@Dimnames
tmp <- as.matrix(tmp, row.names = tmp@Dimnames)
tmp <- as.data.frame(tmp)
tmp <- tmp %>% rownames_to_column(., var = "rowname") %>% as_tibble()
tmp <- tmp %>% pivot_longer(cols = -1, names_to = "barcode", values_to = "seqlev")

i5 <- full_join(tmp, tmp2)

i5_tmp <-
  i5 %>% #sample_frac(size = 1, replace = FALSE) %>% 
  filter(str_detect(rowname, "UDI")) %>%
  filter(str_detect(barcode, "v2")) %>%
  select(-seqlev) %>%
  filter(hamming > 2) %>%
  pivot_wider(names_from = barcode, values_from = hamming) %>%
  arrange(rowname) %>%
  column_to_rownames(var = "rowname")

pheatmap(
  i5_tmp,
  cluster_rows = T,
  cluster_cols = T,
  fontsize = 10,
  fontsize_row = 6,
  fontsize_col = 6,
  border_color = NA,
  color = viridis(
    n = 6,
    direction = -1,
    option = "rocket",
    end = 0.8
  ),
  clustering_method = "ward.D",
  na_col = "white",
  main = "I5 barcode Hamming distances, Hamming > 2",
  filename = "plots/i5_hamming_greater2.pdf",
  width = 10,
  height = 7.5
)

pheatmap(
  i5_tmp,
  cluster_rows = F,
  cluster_cols = F,
  fontsize = 10,
  fontsize_row = 6,
  fontsize_col = 6,
  border_color = NA,
  color = viridis(
    n = 6,
    direction = -1,
    option = "rocket",
    end = 0.8
  ),
  na_col = "white",
  main = "I5 barcode Hamming distances, Hamming > 2",
  filename = "plots/i5_hamming_greater2_unclustered.pdf",
  width = 10,
  height = 7.5
)

pheatmap(
  i5_tmp,
  cluster_rows = T,
  cluster_cols = T,
  fontsize = 10,
  fontsize_row = 6,
  fontsize_col = 6,
  border_color = NA,
  color = viridis(
    n = 6,
    direction = -1,
    option = "rocket",
    end = 0.8
  ),
  clustering_method = "ward.D",
  na_col = "white",
  main = "I5 barcode Hamming distances, Hamming > 2",
  filename = "plots/i5_hamming_greater2.png",
  width = 10,
  height = 7.5
)

pheatmap(
  i5_tmp,
  cluster_rows = F,
  cluster_cols = F,
  fontsize = 10,
  fontsize_row = 6,
  fontsize_col = 6,
  border_color = NA,
  color = viridis(
    n = 6,
    direction = -1,
    option = "rocket",
    end = 0.8
  ),
  na_col = "white",
  main = "I5 barcode Hamming distances, Hamming > 2",
  filename = "plots/i5_hamming_greater2_unclustered.png",
  width = 10,
  height = 7.5
)
```

![I5 hamming distance > 2](plots/i5_hamming_greater2.png)

![I5 hamming distance > 2](plots/i5_hamming_greater2_unclustered.png)
